[
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2024-11-14 17:41:07.074694",
  "module": "Property Management Solution",
  "name": "Before lease saved",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Lease",
  "script": "# Assuming `property` is a field in your Lease DocType referring to the Property document\nproperty_doc = frappe.get_doc(\"Property\", doc.property)\n\n# Check if the property is booked or sold\nif property_doc.status in [\"Booked\", \"Sold\"]:\n    frappe.throw(f\"The property {property_doc.name} is currently {property_doc.status}. You cannot create a lease for it.\")\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2024-12-18 16:38:23.890781",
  "module": "Property Management Solution",
  "name": "Fetch Reservations",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Target",
  "script": "if doc.sales_person:\n    # Get the first and last day of the current month\n    today = datetime.date.today()\n    first_day = datetime.date(today.year, today.month, 1)\n    if today.month == 12:\n        last_day = datetime.date(today.year + 1, 1, 1) - datetime.timedelta(days=1)\n    else:\n        last_day = datetime.date(today.year, today.month + 1, 1) - datetime.timedelta(days=1)\n\n    reservations = frappe.db.sql(\"\"\"\n        SELECT SUM(price)\n        FROM `tabReservation`\n        WHERE sales_person = %s\n          AND status = 'Reserve'  \n          AND creation BETWEEN %s AND %s -- Filter by creation date within the current month\n    \"\"\", (doc.sales_person, first_day, last_day), as_dict=True) # tuple for parameters\n\n    if reservations and reservations[0]['SUM(price)']:\n        doc.reservations = reservations[0]['SUM(price)']\n    else:\n        doc.reservations = 0\n\n",
  "script_type": "DocType Event"
 }
]