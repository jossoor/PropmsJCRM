[
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "After Insert",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2025-01-03 23:44:44.659498",
  "module": "Property Management Solution",
  "name": "On Lease Price",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Property",
  "script": "if doc.status == \"On Lease\" and doc.price_per_month_day:\n    total_price = 40 * doc.price_per_month_day\n\n    frappe.db.set_value(\"Property\", doc.name, \"total_price\", total_price)\n\n    frappe.log_error(\n        message=f\"Total price updated to {total_price} for Property {doc.name}\",\n        title=\"Total Price Update\"\n    )\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "Before Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2024-11-14 17:41:07.074694",
  "module": "Property Management Solution",
  "name": "Before lease saved",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Lease",
  "script": "# Assuming `property` is a field in your Lease DocType referring to the Property document\nproperty_doc = frappe.get_doc(\"Property\", doc.property)\n\n# Check if the property is booked or sold\nif property_doc.status in [\"Booked\", \"Sold\"]:\n    frappe.throw(f\"The property {property_doc.name} is currently {property_doc.status}. You cannot create a lease for it.\")\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "After Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2024-12-30 20:03:12.322601",
  "module": "Property Management Solution",
  "name": "Fetch Reservations",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Reservation",
  "script": "if doc.sales_person:\n    # Get the first and last day of the current month\n    today = frappe.utils.today()\n    first_day = frappe.utils.get_first_day(today)\n    last_day = frappe.utils.get_last_day(today)\n    \n    # Get the target document name associated with the sales person\n    target_name = frappe.db.get_value(\n        'Target', \n        filters={'sales_person': doc.sales_person}, \n        fieldname='name'\n    )\n    \n    # Sum up the prices of reservations with status 'Reserve' within the current month\n    reservations = frappe.db.sql(\"\"\"\n        SELECT SUM(price) as total_price\n        FROM `tabReservation`\n        WHERE sales_person = %s\n          AND status = 'Reserve'\n          AND creation BETWEEN %s AND %s\n    \"\"\", (doc.sales_person, first_day, last_day), as_dict=True)\n    \n    if target_name:\n        # Update the reservations field in the Target document\n        target_doc = frappe.get_doc('Target', target_name)\n        target_doc.reservations = reservations[0]['total_price'] if reservations and reservations[0]['total_price'] else 0\n        target_doc.save(ignore_permissions=True)\n",
  "script_type": "DocType Event"
 },
 {
  "allow_guest": 0,
  "api_method": null,
  "cron_format": null,
  "disabled": 0,
  "docstatus": 0,
  "doctype": "Server Script",
  "doctype_event": "After Save",
  "enable_rate_limit": 0,
  "event_frequency": "All",
  "modified": "2024-12-30 20:16:24.014837",
  "module": "Property Management Solution",
  "name": "Fetch Done Deals",
  "rate_limit_count": 5,
  "rate_limit_seconds": 86400,
  "reference_doctype": "Deal Is Done",
  "script": "if doc.sales_person:\n    today = frappe.utils.today()\n    first_day = frappe.utils.get_first_day(today)\n    last_day = frappe.utils.get_last_day(today)\n    \n    # Get the target document name associated with the sales person\n    target_name = frappe.db.get_value(\n        'Target', \n        filters={'sales_person': doc.sales_person}, \n        fieldname='name'\n    )\n    \n    # Sum up the final prices of \"Deal Is Done\" records for the sales person\n    done_deal = frappe.db.sql(\"\"\"\n        SELECT SUM(final_price) as total_final_price\n        FROM `tabDeal Is Done`\n        WHERE sales_person = %s\n          AND creation BETWEEN %s AND %s\n    \"\"\", (doc.sales_person, first_day, last_day), as_dict=True)\n    if target_name:\n        \n        # Update the done_deals field in the Target document\n        target_doc = frappe.get_doc('Target', target_name)\n        target_doc.done_deal = done_deal[0]['total_final_price'] if done_deal and done_deal[0]['total_final_price'] else 0\n        target_doc.save(ignore_permissions=True)",
  "script_type": "DocType Event"
 }
]